#!/bin/zsh

# Fetch database and files from Pantheon.
# Expects Pantheon sitename passed, uses live environment.
if type $terminus >/dev/null 2>&1; then
  if type terminus rsync >/dev/null 2>&1; then

    create_nginx () {
      replace=''
      nginxDir=${nginx/'default'/$replace}

      if [[ ! -f "$nginxDir$1.conf" ]]; then
        eval cp "$nginx $nginxDir$1.conf"
        
        # Run again to edit file.
        create_nginx "$1"
      else
        sed -i '' "s/localhost/$directory/g" "$nginxDir$1.conf"
        sed -i '' 's/#include \/usr\/local\/etc\/nginx\/conf.d\/drupal8.conf;/include \/usr\/local\/etc\/nginx\/conf.d\/drupal8.conf;/' "$nginxDir$1.conf"
      fi
    }

    if [[ $localValue ]]; then
      # Check if provided directory exists locally.
      # Check without prefix first, as this is most likely.
      if [[ -d $HOME/$projectsDirectory/${localValue//$pantheonPrefix/} ]]; then
        directory=${localValue//$pantheonPrefix/}
      else
        # Check with prefix.
        if [[ ! -d "$HOME/$projectsDirectory/$localValue" ]]; then
          echo
          echo 'What project are we building? Name of directory.'
          read directory
        fi
      fi

      get_connection () {
        # If no $3, defaults to 'live'.
        env=${3:-'live'}

        sqlFile="$HOME/$projectsDirectory/$2/$2.sql"
        connection=$(terminus connection:info $1.dev --field='MySQL Command')

        # Make sure database is awake
        testConnection=$(terminus env:wake "$localValue.dev")

        message=''
        eval $testConnection
        
        # if [[ $(terminus env:wake "$localValue.dev") =~ "OK" ]]; then
        #   echo 'FINALLY'
        # else
        #   echo 'ok was not in there'
        # fi

        exit 0



        connection=${connection/'mysql'/'mysqldump -v'}
        connection="$connection > $sqlFile"
      }

      # Get code.
      if [[ ! -d "$HOME/$projectsDirectory/$directory" ]]; then
        gitConnection=$(terminus connection:info $localValue.dev --fields='Git Command' --format=string)
        gitConnection=${gitConnection/'aai'/"$HOME/$projectsDirectory/"}

        echo 'Grabbing code...'      
        eval $gitConnection
        echo 'Code complete.'
      fi

      # Get database.
      get_connection "$localValue" "$directory"

      if [[ $connection != *'trying to connect'*  ]]; then
        echo
        echo 'Downloading database...'
        eval $connection
        echo 'Database download complete.'
      else
        echo
        echo 'Could not connect to live db, would you like another environments db? Which one? (dev, test, live)'
        read env

        if [[ $env ]]; then
          get_connection "$localValue" "$directory" "$env"
        fi
      fi

      # Create local database.
      echo
      echo "Creating/updating $directory database..."
      create="mysql -u $sqlUser -p -e 'create database if not exists $directory'"
      eval $create
      echo 'Done.'

      # Import local database.
      echo
      echo 'Importing downloaded database into local database...'
      import="mysql -v -u $sqlUser -p $directory < $sqlFile"
      eval $import
      echo 'Done.'
      echo

      # Cleanup downloaded database file.
      if [[ -f $sqlFile ]]; then
        echo
        echo 'Cleaning up imported database file...'
        rm -rf $sqlFile
        echo 'Done.'
        echo
      fi
      
      # Create nginx configuration.
      if type 'nginx' >/dev/null 2>&1; then
        echo 'Creating nginx configuration file...'
        create_nginx "$directory"
        echo 'Nginx configuration file added.'
        echo 'Restarting nginx, enter computer password when requested...'
        sudo brew services restart nginx
        echo 'Nginx resetarted.'
      fi

      # Add Drupal settings file
      echo 'Coping over settings.local.php file...'
      if [[ -d "$HOME/$projectsDirectory/$directory/sites/default" ]]; then
        cp base/settings.local.php "$HOME/$projectsDirectory/$directory/sites/default"
        sed -i '' "s/\[database-name\]/$directory/" "$HOME/$projectsDirectory/$directory/sites/default/settings.local.php"
      else
        cp base/settings.local.php "$HOME/$projectsDirectory/$directory/web/sites/default"
        sed -i '' "s/\[database-name\]/$directory/" "$HOME/$projectsDirectory/$directory/web/sites/default/settings.local.php"
      fi
      echo 'Settings file created.'

      # Get files.
      if [[ -d "$HOME/$projectsDirectory/$directory" ]]; then
        get_subdirectory "$HOME/$projectsDirectory/" "$directory"

        echo 'Fetching files...'

        # If no subdirectory is set, we know we are in the webroot.
        if [[ -z $sub ]]; then
          if [[ ! -d "$HOME/$projectsDirectory/$directory/sites/default/files" ]]; then
            mkdir "$HOME/$projectsDirectory/$directory/sites/default/files"
          fi

          sync="terminus rsync $localValue.live:files/ $HOME/$projectsDirectory/$directory/sites/default/files -- --progress"
          eval $sync
        else
          if [[ ! -d "$HOME/$projectsDirectory/$directory/web/sites/default/files" ]]; then
            mkdir "$HOME/$projectsDirectory/$directory/web/sites/default/files"
          fi

          sync="terminus rsync $localValue.live:files/ $HOME/$projectsDirectory/$directory/web/sites/default/files -- --progress"
          eval $sync
        fi

        echo 'Files retreived'
      fi
    fi
  else
    echo
    echo 'You need to install the awesomeness of terminus rsync, its a terminus plugin.'
    echo 'Mind if I install it? Respond y or n.'
    read response

    if [[ $response == 'y' || $response == 'yes' ]]; then
      if [[ ! -d $HOME/.terminus/plugins ]]; then
        echo 'Creating terminus plugins directory.'
        mkdir -p $HOME/.terminus/plugins
        echo 'Created.'
      else
        echo
        echo 'Terminus plugins directory already exists, moving along...'
      fi

      if [[ ! -d $HOME/.terminus/plugins/terminus-rsync-plugin ]]; then
        echo 'Installing Terminus Rsync Plugin...'
        composer create-project --no-dev -d $HOME/.terminus/plugins pantheon-systems/terminus-rsync-plugin:~1
        echo 'Plugin installed.'
      else
        echo 'Terminus Rsync Plugin is already installed... not sure how you got here, this is a bug. Add it to the issues queue: https://github.com/kazajhodo/launcher/issues'
        echo
      fi
    fi
  fi
fi
